<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BxB.ware | JSON Studio (Enhanced)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        lavender: { DEFAULT: '#c084fc', glow: 'rgba(192, 132, 252, 0.5)' },
                        obsidian: { bg: '#0f0f0f', sidebar: '#0a0a0a', border: '#2a2a2a' },
                        dark: { bg: '#030005', card: '#0a050f' }
                    },
                    fontFamily: {
                        sans: ['"Space Grotesk"', 'sans-serif'],
                        mono: ['"JetBrains Mono"', 'monospace'],
                    },
                    animation: {
                        'pulse-glow': 'pulseGlow 3s infinite',
                        'fadeIn': 'fadeIn 0.2s ease-out forwards',
                        'scaleIn': 'scaleIn 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        scaleIn: { '0%': { transform: 'scale(0.95)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* Base Styles */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #030005; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #c084fc; }

        .custom-inner-scroll::-webkit-scrollbar { width: 4px; }
        .custom-inner-scroll::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        .custom-inner-scroll::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        .custom-inner-scroll::-webkit-scrollbar-thumb:hover { background: #c084fc; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        body { background-color: #030005; color: white; }

        .glass-panel {
            background: rgba(13, 10, 20, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(192, 132, 252, 0.15);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
            transition: all 0.2s ease-out;
        }
        
        .glass-panel-hover:hover {
            border-color: rgba(192, 132, 252, 0.5);
            transform: translateY(-1px);
        }

        .input-dark {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            padding: 0.5rem;
            border-radius: 0.375rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            width: 100%;
            transition: border-color 0.2s;
        }
        .input-dark:focus { outline: none; border-color: #c084fc; }
        .input-error { border-color: #ef4444 !important; background: rgba(239, 68, 68, 0.1) !important; }

        .btn-primary, .btn-secondary, .btn-danger {
            border-radius: 0.5rem; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s; white-space: nowrap; padding: 0.5rem 1rem; cursor: pointer; justify-content: center;
        }
        .btn-primary { background: #c084fc; color: black; font-weight: bold; }
        .btn-primary:hover { background: #d8b4fe; transform: translateY(-2px); }
        .btn-secondary { background: rgba(255, 255, 255, 0.05); color: white; border: 1px solid rgba(255, 255, 255, 0.1); }
        .btn-secondary:hover { background: rgba(255, 255, 255, 0.1); border-color: white; }
        .btn-danger { background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.15); }
        .btn-danger:hover { background: rgba(239, 68, 68, 0.25); border-color: #ef4444; transform: translateY(-1px); }

        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 100; display: flex; flex-col-reverse; gap: 10px; pointer-events: none; }
        .toast { pointer-events: auto; min-width: 300px; padding: 15px; border-radius: 8px; background: #1a1a1a; border-left: 4px solid #c084fc; color: white; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transform: translateX(100%); animation: slideIn 0.3s forwards; }
        .toast.success { border-color: #4ade80; }
        .toast.error { border-color: #ef4444; }
        @keyframes slideIn { to { transform: translateX(0); } }
        @keyframes slideOut { to { transform: translateX(120%); opacity: 0; } }

        .json-key { color: #c084fc; } .json-string { color: #a5f3fc; } .json-number { color: #fcd34d; } .json-boolean { color: #f87171; } .json-null { color: #9ca3af; }

        .toggle-checkbox:checked { right: 0; border-color: #c084fc; }
        .toggle-checkbox:checked + .toggle-label { background-color: #c084fc; }
        .toggle-checkbox:checked + .toggle-label:before { transform: translateX(100%); }
        .toggle-label { width: 36px; height: 20px; position: relative; display: block; background: #333; border-radius: 20px; cursor: pointer; transition: 0.2s; }
        .toggle-label:before { content: ''; position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; background: #fff; border-radius: 50%; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }

        .badge-base { padding: 6px 8px; font-size: 10px; border-radius: 4px; text-transform: uppercase; font-weight: bold; letter-spacing: 0.5px; text-align: center; width: 100%; display: flex; align-items: center; justify-content: center; gap: 4px; border: 1px solid transparent; }
        .role-owner { background: #450a0a; color: #fecaca; border-color: #991b1b; }
        .role-staff { background: #431407; color: #fed7aa; border-color: #c2410c; }
        .role-reseller { background: #3b0764; color: #e9d5ff; border-color: #7e22ce; }
        .role-vip { background: #713f12; color: #fef08a; border-color: #eab308; }
        .role-premium { background: #831843; color: #fbcfe8; border-color: #db2777; }
        .role-trial { background: #172554; color: #bfdbfe; border-color: #3b82f6; }
        .role-user { background: #1f2937; color: #e5e7eb; border-color: #4b5563; }
        .role-free { background: #111827; color: #9ca3af; border-color: #374151; }

        .status-active { background: #064e3b; color: #a7f3d0; border-color: #059669; }
        .status-banned { background: #450a0a; color: #f87171; border-color: #ef4444; }
        .status-disabled { background: #1f2937; color: #9ca3af; border-color: #4b5563; }
        .status-expired { background: #334155; color: #cbd5e1; border-color: #64748b; }
        .status-test { background: #164e63; color: #a5f3fc; border-color: #0891b2; }

        .status-btn { 
            flex: 1; padding: 6px; text-align: center; font-size: 10px; text-transform: uppercase; font-weight: bold; 
            border: 1px solid #333; background: #111; color: #666; cursor: pointer; transition: all 0.2s;
        }
        .status-btn:first-child { border-radius: 6px 0 0 6px; }
        .status-btn:last-child { border-radius: 0 6px 6px 0; }
        .status-btn.active-online { background: #064e3b; color: #a7f3d0; border-color: #059669; }
        .status-btn.active-maint { background: #713f12; color: #fef08a; border-color: #eab308; }
        .status-btn.active-offline { background: #450a0a; color: #fecaca; border-color: #991b1b; }
        .status-btn.active-planned { background: #3b0764; color: #e9d5ff; border-color: #7e22ce; }

        .role-stat-card {
            background: rgba(255,255,255,0.05); /* Match key input bg */
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 8px; padding: 12px; display: flex; justify-content: space-between; align-items: center;
            transition: transform 0.2s;
        }
        .role-stat-card:hover { transform: translateX(5px); background: rgba(255,255,255,0.1); }

    </style>
</head>
<body class="bg-dark-bg text-white overflow-x-hidden min-h-screen flex flex-col font-sans">

    <canvas id="particles-bg" class="fixed top-0 left-0 w-full h-full pointer-events-none z-0 opacity-30"></canvas>

    <!-- Navbar -->
    <nav class="fixed top-0 w-full z-40 border-b border-white/5 bg-dark-bg/80 backdrop-blur-md">
        <div class="max-w-7xl mx-auto px-4 lg:px-6 h-16 flex items-center justify-between gap-4">
            <div class="flex items-center gap-2 text-lg lg:text-xl font-bold tracking-tighter shrink-0">
                <i data-lucide="file-json" class="text-lavender"></i>
                <span>BxB<span class="text-lavender">.JSON</span> Studio</span>
            </div>
            <div class="flex gap-2 overflow-x-auto no-scrollbar flex-nowrap pr-2">
                <button type="button" onclick="changeTab('dashboard')" class="nav-tab px-3 py-1.5 rounded-md text-sm font-mono transition-colors text-gray-400 hover:text-white whitespace-nowrap"><i data-lucide="layout-dashboard" class="w-4 h-4 inline mr-1"></i>Dash</button>
                <button type="button" onclick="changeTab('keys')" class="nav-tab active px-3 py-1.5 rounded-md text-sm font-mono transition-colors hover:text-lavender text-lavender bg-white/5 whitespace-nowrap">Keys</button>
                <button type="button" onclick="changeTab('changelog')" class="nav-tab px-3 py-1.5 rounded-md text-sm font-mono transition-colors text-gray-400 hover:text-white whitespace-nowrap">Changelog</button>
                <button type="button" onclick="changeTab('scriptinfo')" class="nav-tab px-3 py-1.5 rounded-md text-sm font-mono transition-colors text-gray-400 hover:text-white whitespace-nowrap">ScriptInfo</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="relative z-10 pt-24 pb-10 px-4 max-w-7xl mx-auto w-full h-full flex flex-col lg:flex-row gap-6">
        
        <!-- EDITOR -->
        <div id="main-editor-col" class="w-full lg:w-2/3 flex flex-col gap-6 transition-all duration-300">
            <div class="glass-panel p-4 rounded-xl flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                <div class="flex flex-col md:flex-row items-start md:items-center gap-4 w-full md:w-auto flex-grow">
                    <div class="flex items-center gap-2 flex-shrink-0">
                        <h2 id="current-editor-title" class="text-xl font-bold">Key Generator</h2>
                        <span class="text-xs text-gray-500 font-mono bg-white/5 px-2 py-0.5 rounded">.json</span>
                    </div>
                    <div id="search-container" class="relative w-full md:max-w-xs">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-3 h-3 text-gray-500"></i>
                        <input type="text" id="search-input" placeholder="Search..." class="input-dark pl-8 w-full" oninput="handleSearch(this.value)">
                    </div>
                </div>
                <div class="flex flex-wrap items-center gap-2 w-full md:w-auto justify-start md:justify-end">
                    <div id="default-hwid-container" class="flex items-center gap-2 bg-white/5 px-2 py-1.5 rounded-lg border border-white/10" title="Auto Bind HWID">
                        <span class="text-[10px] text-gray-400 font-bold uppercase whitespace-nowrap">Auto HWID</span>
                        <div class="relative scale-75 origin-center">
                            <input type="checkbox" id="default-hwid-toggle" class="toggle-checkbox absolute opacity-0 w-0 h-0" checked>
                            <label for="default-hwid-toggle" class="toggle-label"></label>
                        </div>
                    </div>
                    <button type="button" id="btn-batch" onclick="openBatchModal()" class="btn-secondary text-xs flex-grow md:flex-grow-0 justify-center hidden"><i data-lucide="layers" class="w-4 h-4"></i> Batch</button>
                    <button type="button" onclick="importJSON()" class="btn-secondary text-xs flex-grow md:flex-grow-0 justify-center"><i data-lucide="upload" class="w-4 h-4"></i> Import</button>
                    <button type="button" id="btn-add-entry" onclick="addNewItem()" class="btn-primary text-xs flex-grow md:flex-grow-0 justify-center"><i data-lucide="plus" class="w-4 h-4"></i> Add Entry</button>
                </div>
            </div>

            <div id="editor-container" class="flex flex-col gap-4"></div>
        </div>

        <!-- PREVIEW -->
        <div id="main-preview-col" class="w-full lg:w-1/3 flex flex-col gap-6 transition-all duration-300">
            <div class="glass-panel p-0 rounded-xl overflow-hidden flex flex-col h-[calc(100vh-8rem)] sticky top-24">
                <div class="p-3 border-b border-white/10 bg-black/20 flex flex-col gap-2">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-bold font-mono text-gray-400">Preview Output</span>
                            <span id="save-indicator" class="text-[10px] text-green-500 opacity-0 transition-opacity">Saved</span>
                        </div>
                        <button type="button" onclick="resetAllData()" class="p-1.5 hover:bg-red-500/10 rounded text-gray-400 hover:text-red-500 transition-colors" title="Reset Local Storage"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>
                    </div>
                    
                    <!-- Export Tools -->
                    <div class="flex gap-2">
                        <div class="flex-grow flex gap-1">
                            <button type="button" onclick="copyToClipboard()" class="flex-1 btn-secondary text-[10px] justify-center" title="Copy JSON Code"><i data-lucide="copy" class="w-3 h-3"></i> JSON</button>
                            <button type="button" onclick="copyKeyList()" class="flex-1 btn-secondary text-[10px] justify-center" title="Copy Key List Only"><i data-lucide="list" class="w-3 h-3"></i> List</button>
                        </div>
                        <div class="flex-grow flex gap-1">
                            <button type="button" onclick="downloadJSON()" class="flex-1 btn-secondary text-[10px] justify-center" title="Download .json"><i data-lucide="download" class="w-3 h-3"></i> .JSON</button>
                            <button type="button" onclick="downloadTXT()" class="flex-1 btn-secondary text-[10px] justify-center" title="Download .txt"><i data-lucide="file-text" class="w-3 h-3"></i> .TXT</button>
                        </div>
                    </div>
                </div>
                <div class="relative flex-grow bg-[#050505] overflow-auto">
                     <pre class="p-4 text-xs font-mono leading-relaxed"><code id="json-preview"></code></pre>
                </div>
                <div class="p-2 border-t border-white/10 bg-black/20 text-center">
                    <span id="status-bar" class="text-[10px] text-gray-500 font-mono">Ready to edit</span>
                </div>
            </div>
        </div>
    </main>

    <!-- CUSTOM CONFIRMATION MODAL -->
    <div id="custom-confirm-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm hidden animate-fadeIn">
        <div class="glass-panel w-[400px] max-w-[90%] p-6 rounded-2xl flex flex-col gap-4 animate-scaleIn border-l-4 border-red-500">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-full bg-red-500/10 flex items-center justify-center text-red-500 shrink-0">
                    <i data-lucide="alert-triangle" class="w-6 h-6"></i>
                </div>
                <div>
                    <h3 id="confirm-title" class="text-lg font-bold text-white">Delete Item?</h3>
                    <p id="confirm-desc" class="text-xs text-gray-400 mt-1">This action cannot be undone. Are you sure you want to proceed?</p>
                </div>
            </div>
            <div class="flex gap-3 mt-2 justify-end">
                <button type="button" onclick="closeConfirmModal()" class="btn-secondary text-xs">Cancel</button>
                <button type="button" id="btn-confirm-action" class="btn-danger text-xs bg-red-500/20 hover:bg-red-500/40 text-red-500 border-red-500/50">Confirm Delete</button>
            </div>
        </div>
    </div>

    <!-- NEW FEATURE KEY MODAL -->
    <div id="feature-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm hidden animate-fadeIn">
        <div class="glass-panel w-[350px] max-w-[90%] p-6 rounded-2xl flex flex-col gap-4 animate-scaleIn border-l-4 border-green-500">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-bold text-white">New Feature</h3>
                <button type="button" onclick="closeFeatureModal()" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div>
                <label class="text-[10px] text-gray-500 uppercase">Feature Key (ID)</label>
                <input id="new-feature-key" type="text" class="input-dark mt-1" placeholder="e.g. aimbot, esp, misc">
            </div>
            <button type="button" onclick="confirmAddFeature()" class="btn-primary w-full justify-center">Create Module</button>
        </div>
    </div>

    <!-- BATCH/BULK ACTIONS MODAL -->
    <div id="batch-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm hidden animate-fadeIn">
        <div class="glass-panel w-[400px] max-w-[90%] p-6 rounded-2xl flex flex-col gap-4 animate-scaleIn border-l-4 border-lavender max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-lg font-bold text-white">Batch Tools</h3>
                <button type="button" onclick="closeBatchModal()" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <!-- Generate Tab -->
            <div class="bg-white/5 p-4 rounded-lg">
                <h4 class="text-xs font-bold text-lavender mb-2 uppercase flex items-center gap-2"><i data-lucide="plus-square" class="w-3 h-3"></i> Bulk Generate</h4>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <input id="bulk-qty" type="number" class="input-dark" placeholder="Qty (e.g. 10)">
                    <select id="bulk-role" class="input-dark">
                        <option value="user">User</option><option value="premium">Premium</option><option value="vip">VIP</option><option value="free">Free</option><option value="reseller">Reseller</option><option value="staff">Staff</option><option value="owner">Owner</option>
                    </select>
                </div>
                <div class="flex gap-2 mb-3">
                    <select id="bulk-days" class="input-dark">
                        <option value="1">1 Day</option><option value="7">7 Days</option><option value="30">30 Days</option><option value="lifetime">Lifetime</option>
                    </select>
                    <button type="button" onclick="generateBulk()" class="btn-primary text-xs flex-grow">Generate</button>
                </div>
            </div>

            <!-- Maintenance / Delete Tab -->
            <div class="bg-white/5 p-4 rounded-lg border border-red-500/20">
                <h4 class="text-xs font-bold text-red-400 mb-3 uppercase flex items-center gap-2"><i data-lucide="trash-2" class="w-3 h-3"></i> Advanced Deletion</h4>
                
                <!-- Expired -->
                <button type="button" onclick="deleteExpiredKeys()" class="btn-secondary w-full text-xs justify-between mb-2 hover:border-red-400/50">
                    <span>Delete Expired Keys</span>
                    <i data-lucide="clock" class="w-3 h-3 text-gray-400"></i>
                </button>

                <!-- By Status -->
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <button type="button" onclick="deleteByStatus('banned')" class="btn-secondary text-xs justify-center hover:bg-red-500/10 hover:border-red-500">Del Banned</button>
                    <button type="button" onclick="deleteByStatus('disabled')" class="btn-secondary text-xs justify-center hover:bg-gray-500/20">Del Disabled</button>
                    <button type="button" onclick="deleteByStatus('test')" class="btn-secondary text-xs justify-center hover:bg-blue-500/20">Del Test</button>
                    <button type="button" onclick="deleteByStatus('expired')" class="btn-secondary text-xs justify-center hover:bg-yellow-500/20">Del Expired</button>
                </div>

                <!-- By Role -->
                <div class="flex gap-2 mb-4 pt-2 border-t border-white/5">
                    <select id="delete-role-select" class="input-dark w-1/2 text-xs">
                        <option value="owner">Owner</option>
                        <option value="staff">Staff</option>
                        <option value="vip">VIP</option>
                        <option value="premium">Premium</option>
                        <option value="reseller">Reseller</option>
                        <option value="free">Free</option>
                        <option value="user">User</option>
                    </select>
                    <button type="button" onclick="deleteByRole()" class="btn-danger w-1/2 text-xs justify-center">Delete Role</button>
                </div>

                <!-- Delete All -->
                <button type="button" onclick="deleteAllKeys()" class="btn-danger w-full text-xs justify-center bg-red-600/20 border-red-600 hover:bg-red-600 hover:text-white font-bold py-2">
                    DELETE ALL KEYS
                </button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>
    <input type="file" id="file-input" class="hidden" accept=".json">
    
    <!-- Hidden Input for Dashboard Import -->
    <input type="file" id="dash-file-input" class="hidden" accept=".json">

    <script>
        lucide.createIcons();

        let currentTab = 'keys'; 
        let searchTerm = '';
        let currentConfirmAction = null; 
        
        // --- STORAGE MANAGER ---
        const STORAGE_KEY = 'bxb_studio_data';
        
        let dataStore = {
            keys: { 
                status: "online", 
                message: "Key server online", 
                version: "1.2.0", 
                last_update: new Date().toISOString(), 
                // NEW: Default Settings
                settings: {
                    prefix: "KEY-",
                    method: "alphanum_6" // alphanum_6, alphanum_12, uuid, numeric_8
                },
                keys: [] 
            },
            changelog: { status: "online", project: "Obsidian Hub", latest_version: "1.5.0", entries: [] },
            scriptinfo: { 
                status: "online", 
                hub_name: "Obsidian Universal Hub", 
                hub_code: "OBSIDIAN_UNI",
                version: "1.5.0", 
                channel: "stable",
                last_update: "2025-12-05 13:45:00",
                description: { short: "", long: "" },
                roles_required: { basic: [], premium_features: [], staff_tools: [] },
                features: {},
                executors_support: { stable: [], partial: [], mobile: [], notes: "" },
                game_support: [],
                credits: [],
                links: { discord: "", github: "", docs: "" }
            }
        };

        // Load from storage or init default
        function loadData() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if(saved) {
                try {
                    const parsed = JSON.parse(saved);
                    dataStore = { ...dataStore, ...parsed };
                    
                    // Init settings if missing from old data
                    if(dataStore.keys && !dataStore.keys.settings) {
                        dataStore.keys.settings = { prefix: "KEY-", method: "alphanum_6" };
                    }
                } catch(e) {
                    console.error("Storage corrupted, loading default");
                }
            } else {
                initDefaultData();
            }
        }

        function initDefaultData() {
             dataStore.keys.keys = [
                { key: "BxB-Owner", role: "owner", status: "active", bind_hwid: false, timestamp: "12/05/25", expire: null, note: "Owner Key", isStarred: true },
                { key: "BxB-User", role: "user", status: "active", bind_hwid: true, hwid_hash:"HASH123", timestamp: "12/05/25", expire: "01/01/26", note: "Normal User", isStarred: false },
            ];
            // Ensure settings exist
            dataStore.keys.settings = { prefix: "KEY-", method: "alphanum_6" };
            
            dataStore.changelog.entries = [
                { 
                    version: "1.5.0", date: "2025-12-05", channel: "stable", status: "released", 
                    title: "Combat & ESP upgrade",
                    highlights: ["Improved aimbot smoothing", "Added ESP distance fade", "Added free-key support"],
                    changes: { added: ["Support for free keys"], changed: ["ESP box scaling"], fixed: ["Fixed groupbox"], removed: [] } 
                }
            ];

            // Sample for ScriptInfo matching requested JSON structure
            dataStore.scriptinfo.description = { short: "Universal hub", long: "Full featured hub for Roblox" };
            dataStore.scriptinfo.features = {
                player: { status: "online", min_role: "free", description: "Movement, teleport, camera, basic utilities." },
                esp: { status: "online", min_role: "user", description: "Player ESP (box, corner, chams, tracers, distance)." },
                aimbot: { status: "online", min_role: "premium", description: "Legit aimbot, random weighted hitpart, prediction." }
            };
            dataStore.scriptinfo.game_support = [{ place_id: 0, name: "Universal", status: "online" }];
            dataStore.scriptinfo.links = { discord: "https://discord.gg/example" };
            saveData();
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(dataStore));
            const ind = document.getElementById('save-indicator');
            if(ind) {
                ind.style.opacity = '1';
                setTimeout(() => ind.style.opacity = '0', 2000);
            }
        }

        function resetAllData() {
            if(confirm("Are you sure you want to reset all data to default? This clears local storage.")) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        // --- RENDER LOGIC ---
        function render() {
            // [SCROLL FIX] 1. Capture Scroll Positions
            const mainScroll = window.scrollY;
            const keysWrapper = document.getElementById('keys-list-wrapper');
            const keysScroll = keysWrapper ? keysWrapper.scrollTop : 0;
            const clWrapper = document.getElementById('changelog-list-wrapper');
            const clScroll = clWrapper ? clWrapper.scrollTop : 0;
            const scriptWrapper = document.getElementById('scriptinfo-list-wrapper');
            const scriptScroll = scriptWrapper ? scriptWrapper.scrollTop : 0;

            const container = document.getElementById('editor-container');
            container.innerHTML = '';
            
            const searchContainer = document.getElementById('search-container');
            const defaultHwidContainer = document.getElementById('default-hwid-container');
            const addBtn = document.getElementById('btn-add-entry');
            const batchBtn = document.getElementById('btn-batch');
            const editorTitle = document.getElementById('current-editor-title');
            
            // Dashboard Layout Control
            const editorCol = document.getElementById('main-editor-col');
            const previewCol = document.getElementById('main-preview-col');

            // Default UI State
            searchContainer.classList.add('hidden');
            defaultHwidContainer.classList.add('hidden');
            addBtn.style.display = 'none';
            batchBtn.classList.add('hidden');

            if(currentTab === 'dashboard') {
                editorTitle.innerText = "Dashboard Overview";
                
                // Hide Preview Column specifically for Dashboard
                previewCol.classList.add('hidden');
                editorCol.classList.remove('lg:w-2/3');
                editorCol.classList.add('w-full');
                
                renderDashboard(container);
            } else {
                // Show Preview Column for other tabs
                previewCol.classList.remove('hidden');
                editorCol.classList.add('lg:w-2/3');
                editorCol.classList.remove('w-full');

                if(currentTab === 'keys') {
                    editorTitle.innerText = "Key Generator";
                    searchContainer.classList.remove('hidden');
                    defaultHwidContainer.classList.remove('hidden');
                    batchBtn.classList.remove('hidden');
                    addBtn.style.display = 'flex';
                    renderKeysTab(container);
                } else if (currentTab === 'changelog') {
                    editorTitle.innerText = "Changelog Editor";
                    addBtn.style.display = 'flex';
                    const listWrapper = document.createElement('div');
                    listWrapper.id = 'changelog-list-wrapper'; // [SCROLL FIX] Add ID
                    // [MOBILE FIX] Removed inner scrolling constraints (lg:overflow-y-auto lg:pr-2 lg:max-h-[600px] custom-scrollbar)
                    listWrapper.className = 'flex flex-col gap-6'; 
                    container.appendChild(listWrapper);
                    dataStore.changelog.entries.forEach((item, index) => renderChangelogCard(listWrapper, item, index));
                } else if (currentTab === 'scriptinfo') {
                    editorTitle.innerText = "Script Info";
                    renderScriptInfoForm(container);
                }
            }

            // Always render global fields UNLESS Dashboard
            if(currentTab !== 'dashboard') {
                const wrapper = document.createElement('div');
                wrapper.className = 'glass-panel p-4 rounded-xl mb-2 flex-shrink-0 order-first'; 
                renderGlobalFields(wrapper); // Render into separate wrapper to prepend
                container.insertBefore(wrapper, container.firstChild);
            }

            updatePreview();
            lucide.createIcons();

            // [SCROLL FIX] 2. Restore Scroll Positions
            window.scrollTo(0, mainScroll);
            
            const newKeysWrapper = document.getElementById('keys-list-wrapper');
            if(newKeysWrapper) newKeysWrapper.scrollTop = keysScroll;
            
            const newClWrapper = document.getElementById('changelog-list-wrapper');
            if(newClWrapper) newClWrapper.scrollTop = clScroll;

            const newScriptWrapper = document.getElementById('scriptinfo-list-wrapper');
            if(newScriptWrapper) newScriptWrapper.scrollTop = scriptScroll;
        }

        // --- DASHBOARD RENDERER ---
        function renderDashboard(container) {
            const keys = dataStore.keys.keys || [];
            const total = keys.length;
            const active = keys.filter(k => k.status === 'active').length;
            const expired = keys.filter(k => k.status === 'expired').length;
            const banned = keys.filter(k => k.status === 'banned').length;
            
            // Calculate Role Counts
            const roleCounts = { owner:0, staff:0, vip:0, premium:0, reseller:0, free:0, user:0, trial:0 };
            keys.forEach(k => {
                const r = k.role.toLowerCase();
                if(roleCounts[r] !== undefined) roleCounts[r]++;
            });

            // Role Card HTML Generator
            const roleCard = (title, count, colorClass) => `
                <div class="role-stat-card">
                    <span class="text-xs font-bold uppercase text-gray-400">${title}</span>
                    <span class="text-sm font-bold ${colorClass}">${count}</span>
                </div>
            `;

            // NEW: SORTING & FILTERING LOGIC
            const now = new Date();
            
            // 1. Latest Keys (Sort by timestamp string desc, assuming ISO format)
            const latestKeys = [...keys].sort((a, b) => (b.timestamp || '').localeCompare(a.timestamp || '')).slice(0, 5);
            
            // 2. Expiring Soon (Active/Test, has expire date, date > now, sort asc)
            const expiringKeys = keys
                .filter(k => {
                    if(!k.expire || (k.status !== 'active' && k.status !== 'test')) return false;
                    const d = parseCustomDate(k.expire);
                    return d && d > now;
                })
                .sort((a, b) => parseCustomDate(a.expire) - parseCustomDate(b.expire))
                .slice(0, 5);

            const renderInsightRow = (k, dateField) => `
                <div class="flex items-center justify-between py-2 border-b border-white/5 last:border-0 hover:bg-white/5 transition-colors px-2 rounded cursor-pointer group" onclick="changeTab('keys'); setTimeout(()=>handleSearch('${k.key}'), 100)">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-8 h-8 rounded bg-white/5 flex items-center justify-center text-gray-400 group-hover:bg-white/10 transition-colors flex-shrink-0">
                            <i data-lucide="${dateField === 'timestamp' ? 'plus' : 'clock'}" class="w-4 h-4"></i>
                        </div>
                        <div class="overflow-hidden">
                            <div class="text-xs font-bold text-white font-mono truncate w-24 md:w-32 group-hover:text-lavender transition-colors" title="${k.key}">${k.key}</div>
                            <div class="badge-base role-${k.role} inline-flex scale-75 origin-left">${k.role}</div>
                        </div>
                    </div>
                    <div class="text-right flex-shrink-0 pl-2">
                        <div class="text-[10px] text-gray-400 font-mono">${k[dateField] ? k[dateField].split(' ')[0] : '-'}</div>
                        <div class="text-[10px] ${k.status === 'active' ? 'text-green-400' : 'text-gray-500'} uppercase font-bold">${k.status}</div>
                    </div>
                </div>`;

            const renderList = (list, dateField) => {
                if(list.length === 0) return '<div class="text-center py-6 text-xs text-gray-600 italic">No data available</div>';
                return list.map(k => renderInsightRow(k, dateField)).join('');
            };

            const html = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="glass-panel p-4 rounded-xl flex items-center justify-between"><div><p class="text-xs text-gray-400 uppercase">Total Keys</p><h3 class="text-3xl font-bold text-white">${total}</h3></div><div class="p-3 bg-white/5 rounded-full"><i data-lucide="key" class="w-6 h-6 text-lavender"></i></div></div>
                    <div class="glass-panel p-4 rounded-xl flex items-center justify-between"><div><p class="text-xs text-gray-400 uppercase">Active</p><h3 class="text-3xl font-bold text-green-400">${active}</h3></div><div class="p-3 bg-green-500/10 rounded-full"><i data-lucide="user-check" class="w-6 h-6 text-green-400"></i></div></div>
                    <div class="glass-panel p-4 rounded-xl flex items-center justify-between"><div><p class="text-xs text-gray-400 uppercase">Expired</p><h3 class="text-3xl font-bold text-gray-400">${expired}</h3></div><div class="p-3 bg-gray-500/10 rounded-full"><i data-lucide="clock" class="w-6 h-6 text-gray-400"></i></div></div>
                    <div class="glass-panel p-4 rounded-xl flex items-center justify-between"><div><p class="text-xs text-gray-400 uppercase">Banned</p><h3 class="text-3xl font-bold text-red-400">${banned}</h3></div><div class="p-3 bg-red-500/10 rounded-full"><i data-lucide="ban" class="w-6 h-6 text-red-400"></i></div></div>
                </div>

                <div class="glass-panel p-6 rounded-xl mb-6">
                    <h3 class="text-sm font-bold text-white mb-6 uppercase tracking-wider flex items-center gap-2"><i data-lucide="users" class="w-4 h-4 text-lavender"></i> Key Role Distribution</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        ${roleCard('Owner', roleCounts.owner, 'text-red-300')}
                        ${roleCard('Staff', roleCounts.staff, 'text-orange-300')}
                        ${roleCard('Reseller', roleCounts.reseller, 'text-purple-300')}
                        ${roleCard('VIP', roleCounts.vip, 'text-yellow-300')}
                        ${roleCard('Premium', roleCounts.premium, 'text-pink-300')}
                        ${roleCard('Trial', roleCounts.trial, 'text-blue-300')}
                        ${roleCard('User', roleCounts.user, 'text-gray-300')}
                        ${roleCard('Free', roleCounts.free, 'text-gray-500')}
                    </div>
                </div>

                <!-- NEW: INSIGHTS SECTION -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <!-- Expiring Soon -->
                    <div class="glass-panel glass-panel-hover p-5 rounded-xl border-t-4 border-orange-500/50">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-sm font-bold text-orange-400 uppercase tracking-wider flex items-center gap-2">
                                <i data-lucide="hourglass" class="w-4 h-4"></i> Expiring Soon
                            </h3>
                            <span class="text-[10px] text-gray-500 bg-white/5 px-2 py-0.5 rounded">Next 5</span>
                        </div>
                        <div class="flex flex-col">
                            ${renderList(expiringKeys, 'expire')}
                        </div>
                    </div>

                    <!-- Latest Created -->
                    <div class="glass-panel glass-panel-hover p-5 rounded-xl border-t-4 border-blue-500/50">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-sm font-bold text-blue-400 uppercase tracking-wider flex items-center gap-2">
                                <i data-lucide="sparkles" class="w-4 h-4"></i> Latest Created
                            </h3>
                            <span class="text-[10px] text-gray-500 bg-white/5 px-2 py-0.5 rounded">Last 5</span>
                        </div>
                        <div class="flex flex-col">
                            ${renderList(latestKeys, 'timestamp')}
                        </div>
                    </div>
                </div>
                
                <!-- DATA VERIFICATION & IMPORT (Unified Theme) -->
                <div class="glass-panel glass-panel-hover p-6 rounded-xl">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sm font-bold text-white uppercase tracking-wider flex items-center gap-2">
                            <i data-lucide="file-code" class="w-4 h-4 text-lavender"></i> Data Verification & Import
                        </h3>
                        <button onclick="triggerDashImport()" class="btn-secondary text-xs">
                            <i data-lucide="upload-cloud" class="w-3 h-3"></i> Upload JSON File
                        </button>
                    </div>
                    
                    <div class="flex flex-col gap-3">
                        <textarea id="dashboard-import-area" class="input-dark w-full h-32 font-mono text-xs" placeholder="Paste your JSON code here or upload a file to verify and load..."></textarea>
                        <div class="flex justify-between items-center">
                            <span id="import-status" class="text-xs text-gray-500 font-mono">Waiting for input...</span>
                            <div class="flex gap-2">
                                <button onclick="document.getElementById('dashboard-import-area').value=''" class="btn-secondary text-xs">Clear</button>
                                <button onclick="analyzeAndLoad()" class="btn-primary text-xs">Analyze & Import</button>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            container.innerHTML = html;
        }
        
        // --- DASHBOARD IMPORT LOGIC ---
        function triggerDashImport() {
            document.getElementById('dash-file-input').click();
        }

        // Listener for dashboard file input
        document.getElementById('dash-file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = (ev) => {
                const content = ev.target.result;
                document.getElementById('dashboard-import-area').value = content;
                // Optional: Auto analyze after upload
                analyzeAndLoad();
            };
            reader.readAsText(file);
            // Reset input so same file can be selected again if needed
            e.target.value = '';
        });

        function analyzeAndLoad() {
            const raw = document.getElementById('dashboard-import-area').value.trim();
            const statusEl = document.getElementById('import-status');
            
            if(!raw) {
                statusEl.innerHTML = '<span class="text-red-400">Error: Empty input</span>';
                return;
            }

            try {
                const json = JSON.parse(raw);
                let detectedType = null;
                let count = 0;

                // Auto-Detect Type
                if (json.keys && Array.isArray(json.keys)) {
                    detectedType = 'keys';
                    count = json.keys.length;
                    dataStore.keys = json; // Update keys store
                } else if (json.entries && Array.isArray(json.entries)) {
                    detectedType = 'changelog';
                    count = json.entries.length;
                    dataStore.changelog = json; // Update changelog store
                } else if (json.features && json.hub_code) {
                    detectedType = 'scriptinfo';
                    count = Object.keys(json.features).length;
                    dataStore.scriptinfo = json; // Update scriptinfo store
                } else {
                    statusEl.innerHTML = '<span class="text-yellow-400">Warning: Unknown JSON format</span>';
                    showToast('Unknown format', 'error');
                    return;
                }

                saveData();
                render(); // Refresh dashboard to show new stats immediately
                
                showToast(`Loaded ${detectedType} (${count} items)`, 'success');

            } catch (e) {
                statusEl.innerHTML = '<span class="text-red-400">Error: Invalid JSON Syntax</span>';
                console.error(e);
            }
        }

        // --- KEYS TAB LOGIC ---
        function renderKeysTab(container) {
            // [NEW SETTINGS PANEL] - MOBILE RESPONSIVE
            const settingsPanel = document.createElement('div');
            // Changed from simple flex-row to flexible container that adapts
            settingsPanel.className = 'glass-panel p-3 rounded-xl mb-4 flex flex-col md:flex-row md:items-center gap-3 md:gap-4';
            const currentSettings = dataStore.keys.settings || { prefix: "KEY-", method: "alphanum_6" };
            
            settingsPanel.innerHTML = `
                <div class="flex items-center gap-2 border-b md:border-0 border-white/10 pb-2 md:pb-0">
                    <i data-lucide="settings-2" class="w-4 h-4 text-gray-400"></i>
                    <span class="text-xs font-bold text-white uppercase">Gen Settings</span>
                </div>
                <div class="hidden md:block h-4 w-px bg-white/10"></div>
                
                <!-- Inputs Container -->
                <div class="grid grid-cols-2 md:flex md:items-center gap-3 w-full md:w-auto">
                    <div class="flex flex-col md:flex-row md:items-center gap-1 md:gap-2">
                        <label class="text-[10px] text-gray-500 uppercase">Prefix</label>
                        <input type="text" class="input-dark w-full md:w-24 py-1 text-xs" value="${currentSettings.prefix}" onchange="updateKeySettings('prefix', this.value)" placeholder="KEY-">
                    </div>
                    <div class="flex flex-col md:flex-row md:items-center gap-1 md:gap-2">
                        <label class="text-[10px] text-gray-500 uppercase">Method</label>
                        <select class="input-dark w-full md:w-40 py-1 text-xs" onchange="updateKeySettings('method', this.value)">
                            <option value="alphanum_6" ${currentSettings.method === 'alphanum_6' ? 'selected' : ''}>Random 6 Chars</option>
                            <option value="alphanum_12" ${currentSettings.method === 'alphanum_12' ? 'selected' : ''}>Random 12 Chars</option>
                            <option value="uuid" ${currentSettings.method === 'uuid' ? 'selected' : ''}>UUID Format</option>
                            <option value="numeric_8" ${currentSettings.method === 'numeric_8' ? 'selected' : ''}>Numeric 8 Digits</option>
                            <option value="blocks_4x4" ${currentSettings.method === 'blocks_4x4' ? 'selected' : ''}>4x4 Blocks (ABCD-EFGH..)</option>
                            <option value="mixed_16" ${currentSettings.method === 'mixed_16' ? 'selected' : ''}>Strong Mixed (16)</option>
                            <option value="readable_12" ${currentSettings.method === 'readable_12' ? 'selected' : ''}>Readable (12)</option>
                            <option value="numeric_12" ${currentSettings.method === 'numeric_12' ? 'selected' : ''}>Numeric 12 Digits</option>
                        </select>
                    </div>
                </div>
            `;
            container.appendChild(settingsPanel);

            const listWrapper = document.createElement('div');
            // [MOBILE FIX] Removed height constraints (h-[750px]) and inner overflow to allow native page scrolling
            listWrapper.className = 'flex flex-col gap-4'; 
            listWrapper.id = 'keys-list-wrapper';
            container.appendChild(listWrapper);

            let displayKeys = dataStore.keys.keys.map((k, i) => ({...k, originalIndex: i}));
            if(searchTerm) {
                const lower = searchTerm.toLowerCase();
                displayKeys = displayKeys.filter(k => k.key.toLowerCase().includes(lower) || (k.note && k.note.toLowerCase().includes(lower)) || k.role.toLowerCase().includes(lower));
            }
            const roleOrder = { owner: 0, staff: 1, vip: 2, premium: 3, reseller: 4, free: 5, user: 6 };
            displayKeys.sort((a, b) => {
                if (a.isStarred !== b.isStarred) return (b.isStarred ? 1 : 0) - (a.isStarred ? 1 : 0);
                const roleA = roleOrder[a.role.toLowerCase()] ?? 99; const roleB = roleOrder[b.role.toLowerCase()] ?? 99;
                if (roleA !== roleB) return roleA - roleB;
                if (a.status !== b.status) return a.status === 'active' ? -1 : 1;
                return 0;
            });
            if (displayKeys.length === 0) listWrapper.innerHTML = '<div class="text-gray-500 text-center text-sm py-10">No keys found. Click "Add Entry".</div>';
            else displayKeys.forEach(item => renderKeyCard(listWrapper, item, item.originalIndex));
        }

        // New helper to update settings
        function updateKeySettings(key, val) {
            if(!dataStore.keys.settings) dataStore.keys.settings = { prefix: "KEY-", method: "alphanum_6" };
            dataStore.keys.settings[key] = val;
            saveData();
            // No need to re-render whole tab, just saving is enough for next generation
        }

        // New Helper for Key Generation
        function generateRandomString(method) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            const charsMixed = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            const charsReadable = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // No I, 1, O, 0
            const nums = '0123456789';
            
            const random = (length, source) => {
                let result = '';
                for (let i = 0; i < length; i++) {
                    result += source.charAt(Math.floor(Math.random() * source.length));
                }
                return result;
            };

            switch(method) {
                case 'alphanum_12': return random(12, chars);
                case 'uuid': return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                        return v.toString(16).toUpperCase();
                    });
                case 'numeric_8': return random(8, nums);
                case 'blocks_4x4': return `${random(4, chars)}-${random(4, chars)}-${random(4, chars)}-${random(4, chars)}`;
                case 'mixed_16': return random(16, charsMixed);
                case 'readable_12': return random(12, charsReadable);
                case 'numeric_12': return random(12, nums);
                case 'alphanum_6': 
                default: return random(6, chars);
            }
        }

        function renderGlobalFields(wrapper) {
            wrapper.innerHTML = '';
            let fieldsToRender = [];
            if(currentTab === 'keys') fieldsToRender = ['status', 'message', 'version', 'last_update'];
            else if(currentTab === 'changelog') fieldsToRender = ['status', 'project', 'latest_version'];
            else if(currentTab === 'scriptinfo') fieldsToRender = ['status', 'hub_name', 'hub_code', 'version', 'channel', 'last_update'];
            else return; 
            
            let html = `<h3 class="text-sm font-bold text-lavender mb-3">Global Settings</h3><div class="grid grid-cols-2 md:grid-cols-4 gap-4">`;
            fieldsToRender.forEach(key => {
                 const value = dataStore[currentTab][key] || '';
                 let inputHtml = '';
                 if (key === 'status') {
                     const status = value.toLowerCase();
                     inputHtml = `<div class="flex w-full"><button type="button" onclick="updateGlobal('status', 'online')" class="status-btn ${status==='online'?'active-online':''}">Online</button><button type="button" onclick="updateGlobal('status', 'maintenance')" class="status-btn ${status==='maintenance'?'active-maint':''}">Maint</button><button type="button" onclick="updateGlobal('status', 'offline')" class="status-btn ${status==='offline'?'active-offline':''}">Offline</button></div>`;
                 } else {
                     inputHtml = `<input type="text" class="input-dark" value="${value}" onchange="updateGlobal('${key}', this.value)">`;
                 }
                 html += `<div><label class="block text-xs text-gray-400 mb-1 capitalize">${key.replace('_', ' ')}</label>${inputHtml}</div>`;
            });
            html += `</div>`;
            wrapper.innerHTML = html;
        }

        // --- DROPDOWN LOGIC ---
        let openDropdownId = null;

        function toggleDropdown(id, event) {
            event.stopPropagation();
            const el = document.getElementById(id);
            
            // Close previous if open
            if (openDropdownId && openDropdownId !== id) {
                const prev = document.getElementById(openDropdownId);
                if(prev) {
                    prev.classList.add('hidden');
                    const prevCard = prev.closest('.glass-panel');
                    if(prevCard) prevCard.style.zIndex = '';
                }
            }

            if (el.classList.contains('hidden')) {
                // Open
                el.classList.remove('hidden');
                openDropdownId = id;
                const currentCard = el.closest('.glass-panel');
                if(currentCard) currentCard.style.zIndex = '30'; // Lift up current card
            } else {
                // Close
                el.classList.add('hidden');
                openDropdownId = null;
                const currentCard = el.closest('.glass-panel');
                if(currentCard) currentCard.style.zIndex = '';
            }
        }

        function selectOption(index, key, value, dropdownId) {
            updateKeyItem(index, key, value);
            // After render(), the old elements are gone.
            // openDropdownId should be cleared.
            openDropdownId = null;
        }

        // Global click to close dropdowns
        window.addEventListener('click', () => {
            if (openDropdownId) {
                const el = document.getElementById(openDropdownId);
                if(el) {
                    el.classList.add('hidden');
                    const currentCard = el.closest('.glass-panel');
                    if(currentCard) currentCard.style.zIndex = '';
                }
                openDropdownId = null;
            }
        });

        // --- KEY CARD ---
        function renderKeyCard(container, item, index) {
            const card = document.createElement('div');
            const isDuplicate = checkDuplicate(item.key) && item.key !== "";
            
            card.className = `glass-panel glass-panel-hover p-4 rounded-xl transition-all group relative flex-shrink-0 ${item.isStarred ? 'border-yellow-500/50 bg-yellow-500/5' : (isDuplicate ? 'border-red-500/50' : '')}`;
            
            const roleOptions = ['owner', 'staff', 'vip', 'premium', 'reseller', 'free', 'user'];
            const statusOptions = ['active', 'banned', 'disabled', 'expired', 'test'];

            // CUSTOM DROPDOWN HTML GENERATOR
            const generateDropdown = (type, options, currentValue) => {
                const dropdownId = `dropdown-${type}-${index}`;
                const optionsHtml = options.map(opt => `
                    <button type="button" onclick="selectOption(${index}, '${type}', '${opt}', '${dropdownId}')" 
                        class="block w-full text-left px-3 py-2 text-xs hover:bg-white/10 text-gray-300 hover:text-white transition-colors flex items-center gap-2">
                        ${type === 'role' ? `<span class="w-2 h-2 rounded-full role-${opt} bg-current"></span>` : ''}
                        <span class="capitalize">${opt}</span>
                        ${opt === currentValue ? '<i data-lucide="check" class="w-3 h-3 ml-auto text-green-400"></i>' : ''}
                    </button>
                `).join('');

                return `
                    <div class="relative w-full">
                        <button type="button" onclick="toggleDropdown('${dropdownId}', event)" class="badge-base ${type === 'role' ? `role-${currentValue}` : `status-${currentValue}`} cursor-pointer w-full flex justify-between px-2">
                            <span>${currentValue}</span>
                            <i data-lucide="chevron-down" class="w-3 h-3 opacity-70"></i>
                        </button>
                        <div id="${dropdownId}" class="hidden absolute top-full left-0 mt-1 w-full bg-[#1a1a1a] border border-white/10 rounded-lg shadow-xl z-20 overflow-hidden">
                            ${optionsHtml}
                        </div>
                    </div>
                `;
            };

            card.innerHTML = `
                <div class="absolute top-3 right-3 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                    <button type="button" onclick="toggleStar(${index})" class="p-1 rounded hover:bg-white/10 ${item.isStarred ? 'text-yellow-400' : 'text-gray-500 hover:text-yellow-400'}"><i data-lucide="star" class="w-4 h-4 ${item.isStarred ? 'fill-yellow-400' : ''}"></i></button>
                    <button type="button" onclick="deleteItem(${index}, 'Key')" class="p-1 rounded hover:bg-red-500/20 text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
                <div class="flex flex-col gap-3">
                    <div class="w-full pr-16">
                         <label class="text-[10px] text-gray-500 uppercase flex items-center gap-1 mb-1">
                            ${item.isStarred ? '<i data-lucide="star" class="w-3 h-3 text-yellow-500 fill-yellow-500"></i>' : ''} Key String
                            ${isDuplicate ? '<span class="text-red-400 ml-2 font-bold">(DUPLICATE)</span>' : ''}
                        </label>
                        <input type="text" class="input-dark font-mono font-bold text-lavender text-sm ${isDuplicate ? 'input-error' : ''}" value="${item.key}" onchange="updateKeyItem(${index}, 'key', this.value)">
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-6 gap-3 items-start">
                        <div class="col-span-1 relative">
                            <label class="text-[10px] text-gray-500 uppercase mb-1 block">Role</label>
                            ${generateDropdown('role', roleOptions, item.role)}
                        </div>
                        <div class="col-span-1 relative">
                            <label class="text-[10px] text-gray-500 uppercase mb-1 block">Status</label>
                            ${generateDropdown('status', statusOptions, item.status)}
                        </div>
                        <div class="col-span-2 md:col-span-2"><div class="flex items-center justify-between mb-1"><label class="text-[10px] text-gray-500 uppercase">HWID Bind</label><div class="relative scale-75 origin-right"><input type="checkbox" id="toggle-${index}" class="toggle-checkbox absolute opacity-0 w-0 h-0" ${item.bind_hwid ? 'checked' : ''} onchange="updateKeyItem(${index}, 'bind_hwid', this.checked)"><label for="toggle-${index}" class="toggle-label"></label></div></div>${item.bind_hwid ? `<input type="text" placeholder="Hash..." class="input-dark text-[10px] animate-[fadeIn_0.3s]" value="${item.hwid_hash || ''}" onchange="updateKeyItem(${index}, 'hwid_hash', this.value)">` : '<div class="h-8 flex items-center justify-center text-[10px] text-gray-600 border border-white/5 rounded bg-white/5 italic">Not Bound</div>'}</div>
                        <div class="col-span-1"><label class="text-[10px] text-gray-500 uppercase mb-1 block">Created</label><input type="text" class="input-dark text-[10px]" value="${item.timestamp || ''}" onchange="updateKeyItem(${index}, 'timestamp', this.value)" placeholder="Unix/Date"></div>
                        <div class="col-span-1">
                            <label class="text-[10px] text-gray-500 uppercase block mb-1">Expires</label>
                            <input type="text" class="input-dark text-[10px]" value="${item.expire || ''}" onchange="updateKeyItem(${index}, 'expire', this.value)" placeholder="1d, 1hr, 1min...">
                        </div>
                    </div>
                    <div class="w-full"><div class="relative"><i data-lucide="sticky-note" class="absolute top-2 left-2 w-3 h-3 text-gray-600"></i><input type="text" placeholder="Add a note..." class="input-dark pl-7 text-gray-400 italic text-[10px]" value="${item.note || ''}" onchange="updateKeyItem(${index}, 'note', this.value)"></div></div>
                </div>
            `;
            container.appendChild(card);
        }

        // --- CHANGELOG & SCRIPTINFO RENDERERS ---
        function renderChangelogCard(container, item, index) {
            // UNIFIED THEME: glass-panel-hover, removed border-l-4
            const card = document.createElement('div'); 
            card.className = 'glass-panel glass-panel-hover p-4 rounded-xl flex-shrink-0 group relative';
            
            const renderList = (type, list, changeType = null) => {
                if (!list) list = [];
                const itemsHtml = list.map((txt, i) => `<div class="flex gap-2 mb-1"><span class="text-gray-600 text-xs"></span><input type="text" class="input-dark text-xs py-1" value="${txt}" onchange="updateChangelogNested(${index}, '${type}', ${i}, this.value, '${changeType || ''}')"><button type="button" onclick="removeChangelogNested(${index}, '${type}', ${i}, '${changeType || ''}')" class="text-red-400 hover:text-red-300 opacity-50 hover:opacity-100"><i data-lucide="x" class="w-3 h-3"></i></button></div>`).join('');
                return `<div class="h-[140px] overflow-y-auto pr-1 custom-inner-scroll space-y-1 mb-2 bg-black/20 rounded p-1 border border-white/5">${itemsHtml.length > 0 ? itemsHtml : '<div class="text-[10px] text-gray-600 italic p-2">No items</div>'}</div><button type="button" onclick="addChangelogNested(${index}, '${type}', '${changeType || ''}')" class="text-[10px] text-lavender hover:underline flex items-center gap-1 opacity-70 hover:opacity-100">+ Add Line</button>`;
            };
            
            // Replaced left border color with a colored badge for version
            card.innerHTML = `<div class="flex flex-col gap-4">
                <div class="flex justify-between items-start gap-4">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 flex-grow">
                        <div class="relative">
                             <label class="text-[10px] text-gray-500 uppercase">Version</label>
                             <div class="relative w-full">
                                <div class="badge-base role-reseller cursor-pointer">${item.version}</div>
                                <input class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" value="${item.version}" onchange="updateChangelogItem(${index}, 'version', this.value)">
                             </div>
                        </div>
                        <div><label class="text-[10px] text-gray-500 uppercase">Date</label><input class="input-dark" value="${item.date}" onchange="updateChangelogItem(${index}, 'date', this.value)"></div>
                        <div><label class="text-[10px] text-gray-500 uppercase">Channel</label><input class="input-dark" value="${item.channel || 'stable'}" onchange="updateChangelogItem(${index}, 'channel', this.value)"></div>
                        <div><label class="text-[10px] text-gray-500 uppercase">Status</label><input class="input-dark" value="${item.status || 'released'}" onchange="updateChangelogItem(${index}, 'status', this.value)"></div>
                    </div>
                    <button type="button" onclick="deleteItem(${index}, 'Log Entry')" class="p-1 rounded hover:bg-red-500/20 text-red-500 flex-shrink-0 mt-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
                <div><label class="text-[10px] text-gray-500 uppercase">Title / Headline</label><input class="input-dark font-bold text-sm" value="${item.title || ''}" placeholder="e.g. Combat & ESP Update" onchange="updateChangelogItem(${index}, 'title', this.value)"></div>
                <div class="bg-white/5 p-3 rounded-lg border border-white/5"><label class="text-[10px] text-gray-400 uppercase font-bold flex items-center gap-2 mb-2"><i data-lucide="star" class="w-3 h-3 text-yellow-400"></i> Highlights</label>${renderList('highlights', item.highlights)}</div>
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 bg-black/20 p-3 rounded-lg">
                    <div><h4 class="text-[10px] font-bold text-green-400 mb-2 uppercase tracking-wider">Added</h4>${renderList('changes', item.changes?.added || [], 'added')}</div>
                    <div><h4 class="text-[10px] font-bold text-yellow-400 mb-2 uppercase tracking-wider">Changed</h4>${renderList('changes', item.changes?.changed || [], 'changed')}</div>
                    <div><h4 class="text-[10px] font-bold text-blue-400 mb-2 uppercase tracking-wider">Fixed</h4>${renderList('changes', item.changes?.fixed || [], 'fixed')}</div>
                    <div><h4 class="text-[10px] font-bold text-red-400 mb-2 uppercase tracking-wider">Removed</h4>${renderList('changes', item.changes?.removed || [], 'removed')}</div>
                </div></div>`;
            container.appendChild(card);
        }

        function renderScriptInfoForm(container) {
             const data = dataStore.scriptinfo;
             const scrollContainer = document.createElement('div');
             scrollContainer.id = 'scriptinfo-list-wrapper'; 
             // [MOBILE FIX] Removed inner scrolling constraints (lg:overflow-y-auto lg:pr-2 lg:max-h-[600px] custom-scrollbar)
             scrollContainer.className = 'flex flex-col gap-6';
             
             // UNIFIED THEME: glass-panel-hover, removed colored borders
             // --- Script Info Sections (Updated Logic) ---
             const descHtml = `<div class="glass-panel glass-panel-hover p-4 rounded-xl"><h3 class="text-sm font-bold text-blue-400 mb-3 flex items-center gap-2"><i data-lucide="info" class="w-4 h-4"></i> Details & Links</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="text-[10px] text-gray-500">Short Description</label><input class="input-dark mb-2" value="${data.description.short||''}" onchange="updateDeep('description', 'short', this.value)"><label class="text-[10px] text-gray-500">Long Description</label><textarea class="input-dark h-20" onchange="updateDeep('description', 'long', this.value)">${data.description.long||''}</textarea></div><div class="space-y-2"><div><label class="text-[10px] text-gray-500">Discord</label><input class="input-dark" value="${data.links.discord||''}" onchange="updateDeep('links', 'discord', this.value)"></div><div><label class="text-[10px] text-gray-500">GitHub</label><input class="input-dark" value="${data.links.github||''}" onchange="updateDeep('links', 'github', this.value)"></div><div><label class="text-[10px] text-gray-500">Docs</label><input class="input-dark" value="${data.links.docs||''}" onchange="updateDeep('links', 'docs', this.value)"></div></div></div></div>`;
             
             // Safely get arrays
             const basicRoles = (data.roles_required?.basic || []).join(',');
             const premiumRoles = (data.roles_required?.premium_features || []).join(',');
             const staffRoles = (data.roles_required?.staff_tools || []).join(',');
             const stableExecs = (data.executors_support?.stable || []).join(',');
             const partialExecs = (data.executors_support?.partial || []).join(',');
             const mobileExecs = (data.executors_support?.mobile || []).join(',');
             const execNotes = data.executors_support?.notes || '';

             const configHtml = `<div class="glass-panel glass-panel-hover p-4 rounded-xl"><h3 class="text-sm font-bold text-yellow-400 mb-3 flex items-center gap-2"><i data-lucide="settings" class="w-4 h-4"></i> Configuration</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="text-[10px] text-yellow-400 font-bold mb-1 block">Required Roles</label><div class="space-y-1"><input class="input-dark text-xs" placeholder="Basic" value="${basicRoles}" onchange="updateArrayStr('roles_required', 'basic', this.value)"><input class="input-dark text-xs" placeholder="Premium" value="${premiumRoles}" onchange="updateArrayStr('roles_required', 'premium_features', this.value)"><input class="input-dark text-xs" placeholder="Staff" value="${staffRoles}" onchange="updateArrayStr('roles_required', 'staff_tools', this.value)"></div></div><div><label class="text-[10px] text-yellow-400 font-bold mb-1 block">Executors</label><div class="space-y-1"><input class="input-dark text-xs" placeholder="Stable" value="${stableExecs}" onchange="updateArrayStr('executors_support', 'stable', this.value)"><input class="input-dark text-xs" placeholder="Partial" value="${partialExecs}" onchange="updateArrayStr('executors_support', 'partial', this.value)"><input class="input-dark text-xs" placeholder="Mobile" value="${mobileExecs}" onchange="updateArrayStr('executors_support', 'mobile', this.value)"><input class="input-dark text-xs" placeholder="Notes" value="${execNotes}" onchange="updateDeep('executors_support', 'notes', this.value)"></div></div></div></div>`;
             
             let featuresList = ''; for(const [k,f] of Object.entries(data.features||{})) featuresList += `<div class="bg-white/5 p-2 rounded flex gap-2 items-center mb-2"><div class="w-1/4 font-mono text-xs text-lavender">${k}</div><select class="input-dark w-1/6 text-[10px]" onchange="updateFeature('${k}','status',this.value)"><option value="online" ${f.status==='online'?'selected':''}>On</option><option value="maintenance" ${f.status==='maintenance'?'selected':''}>Maint</option><option value="planned" ${f.status==='planned'?'selected':''}>Plan</option></select><input class="input-dark w-1/6 text-[10px]" placeholder="Role" value="${f.min_role||''}" onchange="updateFeature('${k}','min_role',this.value)"><input class="input-dark w-1/3 text-[10px]" placeholder="Desc" value="${f.description||''}" onchange="updateFeature('${k}','description',this.value)"><button type="button" onclick="deleteFeature('${k}')" class="text-red-400"><i data-lucide="x" class="w-3 h-3"></i></button></div>`;
             const featuresHtml = `<div class="glass-panel glass-panel-hover p-4 rounded-xl"><div class="flex justify-between mb-3"><h3 class="text-sm font-bold text-green-400 flex items-center gap-2"><i data-lucide="cpu" class="w-4 h-4"></i> Features Modules</h3><button type="button" onclick="openFeatureModal()" class="btn-secondary text-[10px]">Add Feature</button></div><div class="bg-black/20 p-2 rounded max-h-[200px] overflow-y-auto custom-inner-scroll">${featuresList}</div></div>`;
             
             let gamesList = ''; (data.game_support || []).forEach((g,i) => { gamesList += `<div class="flex gap-2 items-center bg-white/5 p-2 rounded mb-2"><input class="input-dark w-1/6 text-[10px]" placeholder="ID" value="${g.place_id||0}" onchange="updateGame(${i}, 'place_id', this.value)"><input class="input-dark w-1/4 text-[10px]" placeholder="Name" value="${g.name||''}" onchange="updateGame(${i}, 'name', this.value)"><select class="input-dark w-1/6 text-[10px]" onchange="updateGame(${i}, 'status', this.value)"><option value="online" ${g.status==='online'?'selected':''}>On</option><option value="maintenance" ${g.status==='maintenance'?'selected':''}>Maint</option></select><input class="input-dark w-1/4 text-[10px]" placeholder="Module" value="${g.module||''}" onchange="updateGame(${i}, 'module', this.value)"><button type="button" onclick="deleteGame(${i})" class="text-red-400"><i data-lucide="trash" class="w-3 h-3"></i></button></div>`; });
             const gamesHtml = `<div class="glass-panel glass-panel-hover p-4 rounded-xl"><div class="flex justify-between mb-3"><h3 class="text-sm font-bold text-purple-400 flex items-center gap-2"><i data-lucide="gamepad-2" class="w-4 h-4"></i> Game Support</h3><button type="button" onclick="addGameSupport()" class="btn-secondary text-[10px]">Add Game</button></div><div class="bg-black/20 p-2 rounded max-h-[200px] overflow-y-auto custom-inner-scroll">${gamesList}</div></div>`;

             let creditsList = ''; (data.credits || []).forEach((c,i) => { creditsList += `<div class="flex gap-2 items-center bg-white/5 p-2 rounded mb-2"><input class="input-dark w-1/4 text-[10px]" placeholder="Role" value="${c.role||''}" onchange="updateCredit(${i}, 'role', this.value)"><input class="input-dark w-1/4 text-[10px]" placeholder="Name" value="${c.name||''}" onchange="updateCredit(${i}, 'name', this.value)"><input class="input-dark w-1/2 text-[10px]" placeholder="Note" value="${c.note||''}" onchange="updateCredit(${i}, 'note', this.value)"><button type="button" onclick="deleteCredit(${i})" class="text-red-400"><i data-lucide="trash" class="w-3 h-3"></i></button></div>`; });
             const creditsHtml = `<div class="glass-panel glass-panel-hover p-4 rounded-xl"><div class="flex justify-between mb-3"><h3 class="text-sm font-bold text-pink-400 flex items-center gap-2"><i data-lucide="heart" class="w-4 h-4"></i> Credits</h3><button type="button" onclick="addCredit()" class="btn-secondary text-[10px]">Add Credit</button></div><div class="bg-black/20 p-2 rounded max-h-[200px] overflow-y-auto custom-inner-scroll">${creditsList}</div></div>`;

             scrollContainer.innerHTML = descHtml + configHtml + featuresHtml + gamesHtml + creditsHtml;
             container.appendChild(scrollContainer);
        }

        // --- LOGIC ---
        function handleSearch(val) { searchTerm = val; render(); }
        function toggleStar(index) { dataStore.keys.keys[index].isStarred = !dataStore.keys.keys[index].isStarred; render(); saveData(); }
        function updateGlobal(key, val) { 
            dataStore[currentTab][key] = val; 
            saveData();
            if(key === 'status') render(); else updatePreview(); 
        }

        // [FEATURE] Enhanced Expiration Date Calculator
        function calculateExpiration(input) {
            if (!input) return input;
            const regex = /(\d+)\s*(y|m|w|d|hr|h|min|sec|s)/gi;
            let match;
            let hasMatch = false;
            const now = new Date();
            while ((match = regex.exec(input)) !== null) {
                hasMatch = true;
                const amount = parseInt(match[1]);
                const unit = match[2].toLowerCase();
                switch(unit) {
                    case 'y': now.setFullYear(now.getFullYear() + amount); break;
                    case 'm': now.setMonth(now.getMonth() + amount); break;
                    case 'w': now.setDate(now.getDate() + (amount * 7)); break;
                    case 'd': now.setDate(now.getDate() + amount); break;
                    case 'h': case 'hr': now.setHours(now.getHours() + amount); break;
                    case 'min': now.setMinutes(now.getMinutes() + amount); break;
                    case 's': case 'sec': now.setSeconds(now.getSeconds() + amount); break;
                }
            }
            if (!hasMatch) return input;
            const pad = (n) => String(n).padStart(2, '0');
            return `${pad(now.getDate())}/${pad(now.getMonth() + 1)}/${now.getFullYear()} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
        }

        function updateKeyItem(index, key, val) {
            if (key === 'expire') {
                if (val && val.toLowerCase().trim() === 'lifetime') {
                    val = null;
                } else {
                    const calculatedDate = calculateExpiration(val);
                    val = calculatedDate; 
                }
            }
            dataStore.keys.keys[index][key] = val;
            if (key === 'bind_hwid') { if(!val) delete dataStore.keys.keys[index].hwid_hash; else if(!dataStore.keys.keys[index].hwid_hash) dataStore.keys.keys[index].hwid_hash = ""; }
            saveData();
            if (['bind_hwid','role','status'].includes(key) || key === 'key' || key === 'expire') render(); else updatePreview();
        }
        
        function setExpire(index, days) {
            let newVal = null;
            if (days > 0) { const d = new Date(); d.setDate(d.getDate() + days); newVal = d.toLocaleDateString('en-GB') + " 00:00:00"; }
            dataStore.keys.keys[index].expire = newVal; render(); saveData();
        }
        function checkDuplicate(keyString) { if(!dataStore.keys.keys) return false; return dataStore.keys.keys.filter(k => k.key === keyString).length > 1; }

        // Feature Modal
        function openFeatureModal() { document.getElementById('feature-modal').classList.remove('hidden'); document.getElementById('feature-modal').classList.add('flex'); }
        function closeFeatureModal() { document.getElementById('feature-modal').classList.add('hidden'); document.getElementById('feature-modal').classList.remove('flex'); document.getElementById('new-feature-key').value = ''; }
        function confirmAddFeature() {
            const key = document.getElementById('new-feature-key').value.trim();
            if(key) {
                if(dataStore.scriptinfo.features[key]) { showToast('Feature key exists!', 'error'); return; }
                dataStore.scriptinfo.features[key] = { status: 'planned', min_role: 'free', description: '' };
                render(); closeFeatureModal(); saveData();
            }
        }

        // Batch Modal Logic
        function openBatchModal() { document.getElementById('batch-modal').classList.remove('hidden'); document.getElementById('batch-modal').classList.add('flex'); }
        function closeBatchModal() { document.getElementById('batch-modal').classList.add('hidden'); document.getElementById('batch-modal').classList.remove('flex'); }
        
        function generateBulk() {
            const qty = parseInt(document.getElementById('bulk-qty').value) || 0;
            const role = document.getElementById('bulk-role').value;
            const days = document.getElementById('bulk-days').value;
            if(qty <= 0) return alert("Please enter valid quantity");
            let expireVal = null;
            if(days !== 'lifetime') { const d = new Date(); d.setDate(d.getDate() + parseInt(days)); expireVal = d.toLocaleDateString('en-GB') + " 00:00:00"; }
            
            // USE NEW SETTINGS FOR BATCH TOO
            const prefix = (dataStore.keys.settings && dataStore.keys.settings.prefix) ? dataStore.keys.settings.prefix : 'KEY-';
            const method = (dataStore.keys.settings && dataStore.keys.settings.method) ? dataStore.keys.settings.method : 'alphanum_6';

            for(let i=0; i<qty; i++) {
                const randomStr = generateRandomString(method);
                dataStore.keys.keys.unshift({ key: `${prefix}${randomStr}`, role: role, status: 'active', bind_hwid: true, timestamp: new Date().toISOString(), expire: expireVal, note: `Batch generated`, isStarred: false });
            }
            saveData();
            closeBatchModal(); render(); showToast(`Generated ${qty} keys!`, 'success');
        }

        // --- NEW IMPLEMENTED FUNCTIONS ---

        // Helper to parse "DD/MM/YYYY HH:mm:ss" used in this tool
        function parseCustomDate(dateStr) {
            if (!dateStr) return null;
            try {
                const [dPart, tPart] = dateStr.trim().split(' ');
                const parts = dPart.split('/');
                if (parts.length === 3) {
                    const day = parseInt(parts[0]);
                    const month = parseInt(parts[1]) - 1; 
                    const year = parseInt(parts[2]);
                    let hours = 0, minutes = 0, seconds = 0;
                    if(tPart) {
                        const tParts = tPart.split(':');
                        if(tParts.length >= 2) {
                            hours = parseInt(tParts[0]);
                            minutes = parseInt(tParts[1]);
                            seconds = tParts[2] ? parseInt(tParts[2]) : 0;
                        }
                    }
                    return new Date(year, month, day, hours, minutes, seconds);
                }
            } catch (e) { return null; }
            return null;
        }

        function deleteExpiredKeys() {
            showConfirm("Delete Expired?", "This will remove all keys where date has passed.", () => {
                const now = new Date();
                const initialCount = dataStore.keys.keys.length;
                dataStore.keys.keys = dataStore.keys.keys.filter(k => {
                    if (!k.expire) return true; // Keep lifetime keys
                    const expDate = parseCustomDate(k.expire);
                    if (!expDate) return true; // Keep malformed dates to be safe
                    return expDate >= now; // Keep if date is in future
                });
                const deletedCount = initialCount - dataStore.keys.keys.length;
                saveData();
                render();
                closeBatchModal();
                showToast(`Deleted ${deletedCount} expired keys`, 'success');
            });
        }

        function deleteByStatus(status) {
            showConfirm(`Delete ${status} keys?`, `Remove all keys with status '${status}'.`, () => {
                const initialCount = dataStore.keys.keys.length;
                dataStore.keys.keys = dataStore.keys.keys.filter(k => k.status !== status);
                const deletedCount = initialCount - dataStore.keys.keys.length;
                saveData();
                render();
                closeBatchModal();
                showToast(`Deleted ${deletedCount} keys`, 'success');
            });
        }

        function deleteByRole() {
            const role = document.getElementById('delete-role-select').value;
            showConfirm(`Delete all ${role}s?`, `DANGER: This removes ALL keys with role '${role}'.`, () => {
                 const initialCount = dataStore.keys.keys.length;
                 dataStore.keys.keys = dataStore.keys.keys.filter(k => k.role !== role);
                 const deletedCount = initialCount - dataStore.keys.keys.length;
                 saveData();
                 render();
                 closeBatchModal();
                 showToast(`Deleted ${deletedCount} keys`, 'success');
            });
        }

        function deleteAllKeys() {
            showConfirm("NUKE ALL KEYS?", "CRITICAL: This deletes EVERY key. Cannot be undone.", () => {
                dataStore.keys.keys = [];
                saveData();
                render();
                closeBatchModal();
                showToast('All keys deleted', 'error');
            });
        }

        // ... Update Helpers ...
        function updateChangelogItem(idx, key, val) { dataStore.changelog.entries[idx][key] = val; saveData(); updatePreview(); }
        function updateChangelogNested(entryIdx, type, listIdx, val, changeType) { const entry = dataStore.changelog.entries[entryIdx]; if (type === 'highlights') { if(!entry.highlights) entry.highlights = []; entry.highlights[listIdx] = val; } else { if(!entry.changes) entry.changes = { added:[], changed:[], fixed:[], removed:[] }; entry.changes[changeType][listIdx] = val; } saveData(); updatePreview(); }
        function addChangelogNested(entryIdx, type, changeType) { const entry = dataStore.changelog.entries[entryIdx]; if (type === 'highlights') { if(!entry.highlights) entry.highlights = []; entry.highlights.push("New..."); } else { if(!entry.changes) entry.changes = { added:[], changed:[], fixed:[], removed:[] }; entry.changes[changeType].push("New..."); } saveData(); render(); }
        function removeChangelogNested(entryIdx, type, listIdx, changeType) { const entry = dataStore.changelog.entries[entryIdx]; if (type === 'highlights') entry.highlights.splice(listIdx, 1); else entry.changes[changeType].splice(listIdx, 1); saveData(); render(); }
        
        function updateDeep(parent, key, val) { dataStore.scriptinfo[parent][key] = val; saveData(); updatePreview(); }
        function updateArrayStr(parent, key, val) { dataStore.scriptinfo[parent][key] = val.split(',').map(s=>s.trim()); saveData(); updatePreview(); }
        function updateFeature(key, field, val) { dataStore.scriptinfo.features[key][field] = val; saveData(); updatePreview(); }
        function deleteFeature(key) { delete dataStore.scriptinfo.features[key]; saveData(); render(); }
        
        function updateGame(idx, key, val) { if(key === 'place_id') val = parseInt(val); dataStore.scriptinfo.game_support[idx][key] = val; saveData(); updatePreview(); }
        function deleteGame(idx) { dataStore.scriptinfo.game_support.splice(idx, 1); saveData(); render(); }
        function addGameSupport() { dataStore.scriptinfo.game_support.push({place_id:0, name:'New Game', status:'online'}); saveData(); render(); }
        function updateCredit(idx, key, val) { dataStore.scriptinfo.credits[idx][key] = val; saveData(); updatePreview(); }
        function deleteCredit(idx) { dataStore.scriptinfo.credits.splice(idx, 1); saveData(); render(); }
        function addCredit() { dataStore.scriptinfo.credits.push({role:'dev', name:'Name', note:''}); saveData(); render(); }

        function addNewItem() {
            if (currentTab === 'keys') {
                const defaultBind = document.getElementById('default-hwid-toggle')?.checked ?? true;
                
                // USE SETTINGS FOR NEW KEY
                const settings = dataStore.keys.settings || { prefix: 'KEY-', method: 'alphanum_6' };
                const randomStr = generateRandomString(settings.method);
                const newKey = `${settings.prefix}${randomStr}`;

                dataStore.keys.keys.unshift({ key: newKey, role: "user", status: "active", bind_hwid: defaultBind, timestamp: new Date().toISOString(), expire: null, note: "", isStarred: false });
                if(checkDuplicate(newKey)) showToast('Warning: Key duplicate detected', 'error');
            } else if (currentTab === 'changelog') {
                dataStore.changelog.entries.unshift({ version: "1.0.X", date: new Date().toISOString().split('T')[0], channel: "stable", status: "released", title: "New Update", highlights: [], changes: { added: [], changed: [], fixed: [], removed: [] } });
            }
            saveData();
            render();
            if(currentTab === 'keys') document.getElementById('keys-list-wrapper')?.scrollTo(0,0);
        }

        // Modal Logic
        function showConfirm(title, msg, onConfirm) { document.getElementById('confirm-title').innerText = title; document.getElementById('confirm-desc').innerText = msg; currentConfirmAction = onConfirm; const modal = document.getElementById('custom-confirm-modal'); modal.classList.remove('hidden'); modal.classList.add('flex'); }
        function closeConfirmModal() { const modal = document.getElementById('custom-confirm-modal'); modal.classList.add('hidden'); modal.classList.remove('flex'); currentConfirmAction = null; }
        document.getElementById('btn-confirm-action').addEventListener('click', () => { if(currentConfirmAction) currentConfirmAction(); closeConfirmModal(); });
        function deleteItem(index, typeName) { showConfirm(`Delete ${typeName}?`, `Are you sure?`, () => { dataStore[currentTab][currentTab==='keys'?'keys':'entries'].splice(index, 1); saveData(); render(); showToast(`${typeName} deleted`, 'error'); }); }
        
        function changeTab(tab) {
            currentTab = tab; searchTerm=''; if(document.getElementById('search-input')) document.getElementById('search-input').value='';
            document.querySelectorAll('.nav-tab').forEach(el => { el.classList.remove('active', 'bg-white/5', 'text-lavender'); el.classList.add('text-gray-400'); });
            event.target.classList.add('active', 'bg-white/5', 'text-lavender'); event.target.classList.remove('text-gray-400');
            render();
        }
        function updatePreview() {
            if (!dataStore[currentTab]) {
                document.getElementById('json-preview').innerHTML = '<span class="text-gray-500">// Dashboard Overview Mode<br>// No raw JSON data to display</span>';
                return;
            }
            let clean = JSON.parse(JSON.stringify(dataStore[currentTab]));
            if(currentTab==='keys') {
                delete clean.settings;
                clean.keys = clean.keys.map(({isStarred, originalIndex, ...r})=>r);
                const roleOrder = { owner: 0, staff: 1, vip: 2, premium: 3, reseller: 4, free: 5, user: 6 };
                clean.keys.sort((a, b) => { const roleA = roleOrder[a.role.toLowerCase()] ?? 99; const roleB = roleOrder[b.role.toLowerCase()] ?? 99; if (roleA !== roleB) return roleA - roleB; if (a.status !== b.status) return a.status === 'active' ? -1 : 1; return 0; });
            }
            document.getElementById('json-preview').innerHTML = syntaxHighlight(JSON.stringify(clean, null, 2));
        }
        function syntaxHighlight(json) { return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) { let cls = 'json-number'; if (/^"/.test(match)) { cls = /:$/.test(match) ? 'json-key' : 'json-string'; } else if (/true|false/.test(match)) { cls = 'json-boolean'; } else if (/null/.test(match)) { cls = 'json-null'; } return '<span class="' + cls + '">' + match + '</span>'; }); }
        
        function copyToClipboard() { navigator.clipboard.writeText(document.getElementById('json-preview').innerText); showToast('Copied JSON to clipboard', 'success'); }
        
        // NEW: Copy List
        function copyKeyList() {
            if (currentTab !== 'keys' || !dataStore.keys.keys) {
                showToast('Only available in Keys tab', 'error');
                return;
            }
            const list = dataStore.keys.keys.map(k => k.key).join('\n');
            navigator.clipboard.writeText(list);
            showToast('Copied Key List to clipboard', 'success');
        }

        // NEW: Download TXT
        function downloadTXT() {
            if (currentTab !== 'keys' || !dataStore.keys.keys) {
                showToast('Only available in Keys tab', 'error');
                return;
            }
            const list = dataStore.keys.keys.map(k => k.key).join('\n');
            const a = document.createElement('a');
            a.href = "data:text/plain;charset=utf-8," + encodeURIComponent(list);
            a.download = `keys_list_${new Date().toISOString().slice(0,10)}.txt`;
            a.click();
        }

        function downloadJSON() { 
            let clean = JSON.parse(JSON.stringify(dataStore[currentTab])); 
            if(currentTab==='keys') {
                delete clean.settings;
                clean.keys = clean.keys.map(({isStarred, ...r})=>r);
            }
            const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(clean, null, 2)); a.download = `${currentTab}.json`; a.click(); 
        }
        function importJSON() { document.getElementById('file-input').click(); }
        document.getElementById('file-input').addEventListener('change', (e) => { const file = e.target.files[0]; if(!file)return; const reader = new FileReader(); reader.onload=(ev)=>{ try{ dataStore[currentTab]=JSON.parse(ev.target.result); if(dataStore[currentTab].keys) dataStore[currentTab].keys.forEach(k=>k.isStarred=false); saveData(); render(); showToast('Import successful', 'success'); }catch(e){showToast('Invalid JSON', 'error');} }; reader.readAsText(file); });
        function showToast(msg, type) { const container = document.getElementById('toast-container'); const el = document.createElement('div'); el.className = `toast ${type}`; el.innerHTML = `<span>${msg}</span><i data-lucide="${type==='success'?'check-circle':'alert-circle'}" class="w-5 h-5"></i>`; container.appendChild(el); setTimeout(() => { el.style.animation = 'slideOut 0.3s forwards'; setTimeout(() => el.remove(), 300) }, 3000); lucide.createIcons(); }

        function initBg() { const cvs = document.getElementById('particles-bg'), ctx = cvs.getContext('2d'); function resize() { cvs.width=window.innerWidth; cvs.height=window.innerHeight; } window.addEventListener('resize', resize); resize(); let pts = []; for(let i=0;i<60;i++) pts.push({x:Math.random()*cvs.width, y:Math.random()*cvs.height, vx:(Math.random()-.5)*.3, vy:(Math.random()-.5)*.3}); function anim() { ctx.clearRect(0,0,cvs.width,cvs.height); ctx.fillStyle = '#c084fc'; pts.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; if(p.x<0)p.x=cvs.width; if(p.x>cvs.width)p.x=0; if(p.y<0)p.y=cvs.height; if(p.y>cvs.height)p.y=0; ctx.beginPath(); ctx.arc(p.x,p.y,1.5,0,Math.PI*2); ctx.fill(); }); requestAnimationFrame(anim); } anim(); }
        
        // Init
        loadData();
        initBg(); 
        render();
    </script>
</body>
</html>